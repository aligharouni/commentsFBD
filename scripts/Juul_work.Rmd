---
title: "Juul's paper"
author: "Ali"
date: "`r format(Sys.time(),'%d %b %Y')`"
output: html_document
bibliography: ../AliMac.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev.args = list(png = list(type = "cairo")))
```

```{r packages, echo=FALSE, message=FALSE}
## setwd("~/projects/AliMac_scripts/scripts/")
library(reticulate) ## 
##use_python("/usr/bin/python3")
library(SimilarityMeasures) ## for Fr√©chet distance computation
library(tidyverse)
source('functions.R')
```


## Juul et al's sample data set

This is inspired by @juul2021fixed. 
Retrieving and unpacking the simulated epidemic curves from
the [curvestat repo](https://github.com/jonassjuul/curvestat/).

`npy`-loading instructions  taken from [here](https://cran.r-project.org/web/packages/RcppCNPy/vignettes/UsingReticulate.pdf)

```{r get_juul}
if (!file.exists("./data/juul1.csv")) {
    download.file("https://github.com/jonassjuul/curvestat/raw/master/curvestat/tests/test_data/curves_DKE3.npy", dest="./data/juul1.npy")
    library(reticulate)
    np <- import("numpy")
    a <- np$load("./data/juul1.npy",allow_pickle=TRUE)[[1]]
    m <- do.call(cbind,a)
    write.table(m,file="./data/juul1.csv",row.names=FALSE,col.names=FALSE,
                sep=",")
} else {
    m <- as.matrix(read.csv("./data/juul1.csv")) ## the columns are the trajs
}
```

```{r plot_juul}
par(las=1,bty="l")
matplot(m,type="l",col=adjustcolor("black",alpha.f=0.2), lty=1,
        ylab="")
```

```{r install_curvestat, echo=FALSE}
## ~/Downloads$ sudo apt-get install python3-pip
## clone the curvestats in projects dir
## pip3 install curvestat
py_install("curvestat",pip=TRUE)
while (!py_module_available("curvestat")) {
    py_install("../curvestat",pip=TRUE)
}

py_install("pandas")
```

```{r down_file}
download.file("https://github.com/jonassjuul/curvestat/raw/master/curvestat/tests/test_data/curves_DKE3.npy", dest="./data/juul1.npy")
```

```{python curvestat}
from curvestat import CurveBoxPlot
from curvestat import LoadRisk
## import os
## os.getcwd()
import numpy as np
import pandas as pd
dic_solutions_future = pd.read_csv("./data/juul1.csv")
## dic_solutions_future = np.load("./data/juul1.npy", allow_pickle = True)
## type(dic_solutions_future)
## 149 rows (time points) x 500 curves
nt = dic_solutions_future.shape[0]
time_arr = np.arange(0,nt)
# J_vals = [2, 5, 10, 20, 30, 40, 50]
J_vals = [2,50]
results = np.zeros(shape = (nt, 4*len(J_vals)))
for Ji in range(len(J_vals)):
    print(Ji)
    Boxplot = CurveBoxPlot(curves=dic_solutions_future,sample_curves=J_vals[Ji],
                           sample_repititions=10000,time=time_arr)
    rank_allornothing=Boxplot.rank_allornothing()
    # Get envelope with this choice of ranking
    boundaries = Boxplot.get_boundaries(rank_allornothing,percentiles=[50,90])
    b_lwr50 = boundaries['curve-based'][50]['min-boundary']
    b_upr50 = boundaries['curve-based'][50]['max-boundary']
    b_lwr90 = boundaries['curve-based'][90]['min-boundary']
    b_upr90 = boundaries['curve-based'][90]['max-boundary']
    results[:, 4*Ji] = b_lwr50
    results[:, 4*Ji + 1] = b_upr50
    results[:, 4*Ji + 2] = b_lwr90
    results[:, 4*Ji + 3] = b_upr90
# np.savetxt("./data/juul_boundary1.csv", results, delimiter=',')
np.savetxt("./data/juul_boundary_ss10000.csv", results, delimiter=',')
# np.savetxt("./data/juul_boundary_J2_ss10000.csv", results, delimiter=',')
## plotting ...
## import matplotlib.pyplot as plt
## plt.plot()
## plt.show()
```


```{r col_naming, echo=FALSE}
bnds_juul_temp <- read_csv("./data/juul_boundary_ss10000.csv", col_names = FALSE) ## the columns are 
# J_vals <- c(2, 5, 10, 20, 30, 40, 50)
J_vals <- c(2, 50)

temp <- c()
for (j in J_vals){
     temp <- c(temp, sprintf(c("%s_b_lwr50","%s_b_upr50","%s_b_lwr90","%s_b_upr90"),j))
}
   
colnames(bnds_juul_temp) <- temp 
## FIXME: this change of col names dhould be done in python!
## Pick one of the fname
fname= c("juul_boundary_ss100.csv","juul_boundary_ss10000.csv") 
write.table(bnds_juul_temp,"./data/juul_boundary_ss10000.csv",sep=",",row.names = FALSE)

# Files previously saved:
# data/juul_boundary1.csv: J_vals = [2, 5, 10, 20, 30, 40, 50] , sample_repititions=500.
# data/juul_boundary2.csv: J_vals = [2], sample_repititions=1e5.
# NOTE: the later csv files will be fed into envelope_list in CurveBoxplot.R 
```

# References



